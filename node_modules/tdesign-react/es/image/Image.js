/**
 * tdesign v1.7.1
 * (c) 2024 tdesign
 * @license MIT
 */

import { _ as _defineProperty } from '../_chunks/dep-9d06ffd4.js';
import { _ as _slicedToArray } from '../_chunks/dep-be37289b.js';
import { _ as _objectWithoutProperties } from '../_chunks/dep-97526c3e.js';
import React, { useRef, useState, useEffect, Fragment } from 'react';
import classNames from 'classnames';
import { i as isFunction_1 } from '../_chunks/dep-70de8f55.js';
import { ImageErrorIcon, ImageIcon } from 'tdesign-icons-react';
import observe from '../_common/js/utils/observe.js';
import useConfig from '../hooks/useConfig.js';
import { useLocaleReceiver } from '../locale/LocalReceiver.js';
import { imageDefaultProps } from './defaultProps.js';
import { Space } from '../space/index.js';
import useGlobalIcon from '../hooks/useGlobalIcon.js';
import useDefaultProps from '../hooks/useDefaultProps.js';
import { useImagePreviewUrl } from '../hooks/useImagePreviewUrl.js';
import '../_chunks/dep-e0a22ada.js';
import '../_chunks/dep-08fc9b22.js';
import '../_chunks/dep-f3bac8f4.js';
import '../_chunks/dep-9d4210ce.js';
import '../_chunks/dep-c2c3c04d.js';
import '../config-provider/ConfigContext.js';
import '../_chunks/dep-f870baf9.js';
import '../_chunks/dep-1ff7016b.js';
import '../_chunks/dep-cc3b0635.js';
import '../_chunks/dep-39d65f32.js';
import '../_chunks/dep-48a2bd8e.js';
import '../_chunks/dep-8cf947bb.js';
import '../_chunks/dep-7dbcd8fa.js';
import '../_chunks/dep-e852e0d4.js';
import '../_chunks/dep-dc4499f2.js';
import '../_chunks/dep-213a15b4.js';
import '../_chunks/dep-43f2594d.js';
import '../_chunks/dep-dd510963.js';
import '../_chunks/dep-d8abc91d.js';
import '../_chunks/dep-17c2aa2b.js';
import '../_chunks/dep-ab257f91.js';
import '../_chunks/dep-d4455e7d.js';
import '../_chunks/dep-42e9f2d1.js';
import '../_chunks/dep-02fa0b93.js';
import '../_chunks/dep-24058d76.js';
import '../locale/zh_CN.js';
import '../_common/js/global-config/locale/zh_CN.js';
import '../_chunks/dep-0f18acb0.js';
import 'dayjs';
import '../_chunks/dep-8b683475.js';
import '../_common/js/global-config/default-config.js';
import '../config-provider/index.js';
import '../config-provider/ConfigProvider.js';
import '../space/Space.js';
import 'react-is';
import '../space/defaultProps.js';
import '../_common/js/utils/helper.js';
import '../_chunks/dep-1336b163.js';
import '../_chunks/dep-3f719063.js';
import '../_chunks/dep-72e0f3fe.js';
import '../_chunks/dep-f2dd6554.js';
import '../_chunks/dep-05f57d79.js';
import '../space/style/css.js';
import '../space/type.js';
import '../_common/js/log/index.js';
import '../_common/js/log/log.js';
import '../_common/js/upload/utils.js';

var _excluded = ["className", "src", "style", "fit", "position", "shape", "placeholder", "loading", "error", "overlayTrigger", "lazy", "gallery", "overlayContent", "srcset", "fallback", "onLoad", "onError"],
  _excluded2 = ["alt", "referrerpolicy"];
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function isImageValid(src) {
  return new Promise(function (resolve) {
    var img = document.createElement("img");
    img.onerror = function () {
      return resolve(false);
    };
    img.onload = function () {
      return resolve(true);
    };
    img.src = src;
  });
}
var InternalImage = function InternalImage(originalProps, ref) {
  var props = useDefaultProps(originalProps, imageDefaultProps);
  var className = props.className,
    src = props.src,
    style = props.style,
    fit = props.fit,
    position = props.position,
    shape = props.shape,
    placeholder = props.placeholder,
    loading = props.loading,
    error = props.error,
    overlayTrigger = props.overlayTrigger,
    lazy = props.lazy,
    gallery = props.gallery,
    overlayContent = props.overlayContent,
    srcset = props.srcset,
    fallback = props.fallback,
    onLoad = props.onLoad,
    onError = props.onError,
    waitPassRest = _objectWithoutProperties(props, _excluded);
  var alt = waitPassRest.alt,
    referrerpolicy = waitPassRest.referrerpolicy,
    rest = _objectWithoutProperties(waitPassRest, _excluded2);
  var _useConfig = useConfig(),
    classPrefix = _useConfig.classPrefix;
  var imageRef = useRef(null);
  var _useLocaleReceiver = useLocaleReceiver("image"),
    _useLocaleReceiver2 = _slicedToArray(_useLocaleReceiver, 2),
    local = _useLocaleReceiver2[0],
    t = _useLocaleReceiver2[1];
  var _useGlobalIcon = useGlobalIcon({
      ImageErrorIcon: ImageErrorIcon,
      ImageIcon: ImageIcon
    }),
    ImageErrorIcon$1 = _useGlobalIcon.ImageErrorIcon,
    ImageIcon$1 = _useGlobalIcon.ImageIcon;
  React.useImperativeHandle(ref, function () {
    return imageRef.current;
  });
  var _useState = useState(src),
    _useState2 = _slicedToArray(_useState, 2),
    imageSrc = _useState2[0],
    setImageSrc = _useState2[1];
  useEffect(function () {
    var tmpUrl = isFunction_1(local.replaceImageSrc) ? local.replaceImageSrc(props) : src;
    if (tmpUrl === imageSrc && imageSrc) return;
    setImageSrc(tmpUrl);
  }, [src, local, props]);
  var _useImagePreviewUrl = useImagePreviewUrl(imageSrc),
    previewUrl = _useImagePreviewUrl.previewUrl;
  var _useState3 = useState(!lazy),
    _useState4 = _slicedToArray(_useState3, 2),
    shouldLoad = _useState4[0],
    setShouldLoad = _useState4[1];
  var handleLoadImage = function handleLoadImage() {
    setShouldLoad(true);
  };
  var _useState5 = useState(false),
    _useState6 = _slicedToArray(_useState5, 2),
    isLoaded = _useState6[0],
    setIsLoaded = _useState6[1];
  var handleLoad = function handleLoad(e) {
    setIsLoaded(true);
    onLoad === null || onLoad === void 0 || onLoad({
      e: e
    });
  };
  useEffect(function () {
    if (!lazy || !(imageRef !== null && imageRef !== void 0 && imageRef.current)) {
      return;
    }
    var observerRefValue = null;
    var io = observe(imageRef.current, null, handleLoadImage, 0);
    observerRefValue = imageRef.current;
    return function () {
      observerRefValue && io && io.unobserve(observerRefValue);
    };
  }, [lazy, imageRef]);
  var _useState7 = useState(false),
    _useState8 = _slicedToArray(_useState7, 2),
    hasError = _useState8[0],
    setHasError = _useState8[1];
  var isFirstError = useRef(false);
  var handleError = function handleError(e) {
    isFirstError.current = true;
    setHasError(true);
    if (fallback) {
      setImageSrc(fallback);
      setHasError(false);
    }
    onError === null || onError === void 0 || onError({
      e: e
    });
  };
  var imgRef = useRef();
  useEffect(function () {
    if (hasError && previewUrl) {
      setHasError(false);
    }
    previewUrl && isImageValid(previewUrl).then(function (isValid) {
      setTimeout(function () {
        if (!isValid && !isFirstError.current) {
          handleError(imgRef.current);
        }
      }, 0);
    });
  }, [previewUrl]);
  useEffect(function () {
    if (imgRef.current) {
      var _imgRef$current = imgRef.current,
        complete = _imgRef$current.complete,
        naturalWidth = _imgRef$current.naturalWidth,
        naturalHeight = _imgRef$current.naturalHeight;
      if (complete && naturalWidth !== 0 && naturalHeight !== 0) {
        handleLoad(imgRef.current);
      }
    }
  }, []);
  var hasMouseEvent = overlayTrigger === "hover";
  var _useState9 = useState(!hasMouseEvent),
    _useState10 = _slicedToArray(_useState9, 2),
    shouldShowOverlay = _useState10[0],
    setShouldShowOverlay = _useState10[1];
  var handleToggleOverlay = function handleToggleOverlay(overlay) {
    setShouldShowOverlay(overlay);
  };
  var renderOverlay = function renderOverlay() {
    if (!overlayContent) {
      return null;
    }
    return /* @__PURE__ */React.createElement("div", {
      className: classNames("".concat(classPrefix, "-image__overlay-content"), !shouldShowOverlay && "".concat(classPrefix, "-image__overlay-content--hidden"))
    }, overlayContent);
  };
  var renderPlaceholder = function renderPlaceholder() {
    if (!placeholder) {
      return null;
    }
    return /* @__PURE__ */React.createElement("div", {
      className: "".concat(classPrefix, "-image__placeholder")
    }, placeholder);
  };
  var renderGalleryShadow = function renderGalleryShadow() {
    if (!gallery) {
      return null;
    }
    return /* @__PURE__ */React.createElement("div", {
      className: "".concat(classPrefix, "-image__gallery-shadow")
    });
  };
  var renderImage = function renderImage() {
    var url = typeof imageSrc === "string" ? imageSrc : previewUrl;
    return /* @__PURE__ */React.createElement("img", {
      ref: imgRef,
      src: url,
      onError: handleError,
      onLoad: handleLoad,
      className: classNames("".concat(classPrefix, "-image"), "".concat(classPrefix, "-image--fit-").concat(fit), "".concat(classPrefix, "-image--position-").concat(position)),
      alt: alt,
      referrerPolicy: referrerpolicy
    });
  };
  var renderImageSrcset = function renderImageSrcset() {
    return /* @__PURE__ */React.createElement("picture", null, Object.entries(props.srcset).map(function (_ref) {
      var _ref2 = _slicedToArray(_ref, 2),
        type = _ref2[0],
        url = _ref2[1];
      return /* @__PURE__ */React.createElement("source", {
        key: url,
        type: type,
        srcSet: url
      });
    }), props.src && renderImage());
  };
  return /* @__PURE__ */React.createElement("div", _objectSpread(_objectSpread({
    ref: imageRef,
    className: classNames("".concat(classPrefix, "-image__wrapper"), "".concat(classPrefix, "-image__wrapper--shape-").concat(shape), gallery && "".concat(classPrefix, "-image__wrapper--gallery"), hasMouseEvent && "".concat(classPrefix, "-image__wrapper--need-hover"), className),
    style: style
  }, hasMouseEvent ? {
    onMouseEnter: function onMouseEnter() {
      return handleToggleOverlay(true);
    },
    onMouseLeave: function onMouseLeave() {
      return handleToggleOverlay(false);
    }
  } : null), rest), renderPlaceholder(), renderGalleryShadow(), !(hasError || !shouldLoad) && /* @__PURE__ */React.createElement(Fragment, null, srcset && Object.keys(srcset).length ? renderImageSrcset() : renderImage(), !(hasError || !shouldLoad) && !isLoaded && /* @__PURE__ */React.createElement("div", {
    className: "".concat(classPrefix, "-image__loading")
  }, loading || /* @__PURE__ */React.createElement(Space, {
    direction: "vertical",
    size: 8,
    align: "center"
  }, /* @__PURE__ */React.createElement(ImageIcon$1, {
    size: 24
  }), typeof loading === "string" ? loading : t(local.loadingText)))), hasError && /* @__PURE__ */React.createElement("div", {
    className: "".concat(classPrefix, "-image__error")
  }, error || /* @__PURE__ */React.createElement(Space, {
    direction: "vertical",
    size: 8,
    align: "center"
  }, /* @__PURE__ */React.createElement(ImageErrorIcon$1, {
    size: 24
  }), typeof error === "string" ? error : t(local.errorText))), renderOverlay());
};
var Image = /*#__PURE__*/React.forwardRef(InternalImage);
Image.displayName = "Image";

export { Image as default, isImageValid };
//# sourceMappingURL=Image.js.map
