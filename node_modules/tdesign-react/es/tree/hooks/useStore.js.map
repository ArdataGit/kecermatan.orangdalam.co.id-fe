{"version":3,"file":"useStore.js","sources":["../../../src/tree/hooks/useStore.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport cloneDeep from 'lodash/cloneDeep';\nimport useUpdateEffect from '../../_util/useUpdateEffect';\nimport usePrevious from '../../hooks/usePrevious';\nimport TreeStore from '../../_common/js/tree-v1/tree-store';\nimport { usePersistFn } from '../../_util/usePersistFn';\n\nimport type { TdTreeProps } from '../type';\nimport type { TypeEventState } from '../interface';\nimport type { TypeTreeNodeData } from '../../_common/js/tree-v1/types';\n\nexport function useStore(props: TdTreeProps, refresh: () => void): TreeStore {\n  const storeRef = useRef<TreeStore>();\n  const [filterChanged, toggleFilterChanged] = useState(false);\n  const [prevExpanded, changePrevExpanded] = useState(null);\n  const {\n    data,\n    keys,\n    expandAll,\n    expandParent,\n    expanded,\n    expandLevel,\n    expandMutex,\n    activable,\n    activeMultiple,\n    actived,\n    disabled,\n    draggable,\n    checkable,\n    value,\n    checkStrictly,\n    load,\n    lazy,\n    valueMode,\n    filter,\n    onLoad,\n    allowFoldNodeOnFilter = false,\n  } = props;\n\n  const preFilter = usePrevious(filter);\n\n  useEffect(() => {\n    if (!allowFoldNodeOnFilter) return;\n    toggleFilterChanged(JSON.stringify(preFilter) !== JSON.stringify(filter));\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [filter, allowFoldNodeOnFilter]);\n\n  // 在 update 之后检查，如果之前 filter 有变更，则检查路径节点是否需要展开\n  // 如果 filter 属性被清空，则重置为开启搜索之前的结果\n  const expandFilterPath = () => {\n    if (!allowFoldNodeOnFilter || !filterChanged) return;\n    // 确保 filter 属性未变更时，不会重复检查展开状态\n    toggleFilterChanged(false);\n    const store = storeRef.current;\n    if (props.filter) {\n      if (!prevExpanded) changePrevExpanded(store.getExpanded()); // 缓存之前的展开状态\n\n      // 展开搜索命中节点的路径节点\n      const pathValues = [];\n      const allNodes = store.getNodes();\n      allNodes.forEach((node) => {\n        if (node.vmIsLocked) {\n          pathValues.push(node.value);\n        }\n      });\n      store.setExpanded(pathValues);\n    } else if (prevExpanded) {\n      // filter 属性置空，还原最开始的展开状态\n      store.replaceExpanded(prevExpanded);\n      changePrevExpanded(null);\n    }\n  };\n\n  // 传入 TreeStore 中调用的，但是每次都需要使用最新的值，所以使用 usePersistFn\n  const handleUpdate = usePersistFn(() => {\n    expandFilterPath();\n    refresh();\n  });\n\n  const getExpandedArr = (arr: TdTreeProps['expanded'], store: TreeStore) => {\n    const expandedMap = new Map();\n    arr.forEach((val) => {\n      expandedMap.set(val, true);\n      if (expandParent) {\n        const node = store.getNode(val);\n        node.getParents().forEach((tn) => {\n          expandedMap.set(tn.value, true);\n        });\n      }\n    });\n    return Array.from(expandedMap.keys());\n  };\n\n  const createStore = () => {\n    const store = new TreeStore({\n      keys,\n      activable,\n      activeMultiple,\n      checkable,\n      checkStrictly,\n      expandAll,\n      expandLevel,\n      expandMutex,\n      expandParent,\n      disabled,\n      draggable,\n      load,\n      lazy,\n      valueMode,\n      filter,\n      onLoad: (info: TypeEventState) => {\n        const { node } = info;\n        onLoad?.({\n          node: node.getModel(),\n        });\n      },\n      onUpdate: handleUpdate,\n      allowFoldNodeOnFilter,\n    });\n\n    // 初始化 store 的节点排列 + 状态\n    let list = cloneDeep(data);\n    if (!Array.isArray(list)) {\n      list = [];\n    }\n\n    store.append(list as Array<TypeTreeNodeData>);\n\n    // 刷新节点，必须在配置选中之前执行\n    // 这样选中态联动判断才能找到父节点\n    store.refreshNodes();\n\n    // 初始化选中状态\n    if (Array.isArray(value)) {\n      store.setChecked(value);\n    }\n\n    // 初始化展开状态\n    if (Array.isArray(expanded)) {\n      const expandedArr = getExpandedArr(expanded, store);\n      store.setExpanded(expandedArr);\n    }\n\n    // 初始化激活状态\n    if (Array.isArray(actived)) {\n      store.setActived(actived);\n    }\n\n    store.refreshNodes();\n    return store;\n  };\n\n  if (!storeRef.current) {\n    storeRef.current = createStore();\n  }\n\n  /* ======== 由 props 引发的 store 更新 ======= */\n  const store = storeRef.current;\n\n  useUpdateEffect(() => {\n    if (data && Array.isArray(data)) {\n      const expanded = store.getExpanded();\n      const checked = store.getChecked();\n      const actived = store.getActived();\n      store.removeAll();\n      store.append(data as Array<TypeTreeNodeData>);\n      store.setChecked(checked);\n      store.setActived(actived);\n      store.setExpanded(expanded);\n    }\n  }, [data, store]);\n\n  useUpdateEffect(() => {\n    store.setConfig({\n      keys,\n      expandAll,\n      expandLevel,\n      expandMutex,\n      expandParent,\n      activable,\n      activeMultiple,\n      disabled,\n      checkable,\n      draggable,\n      checkStrictly,\n      load,\n      lazy,\n      valueMode,\n    });\n\n    store.refreshState();\n  }, [\n    activable,\n    activeMultiple,\n    checkStrictly,\n    draggable,\n    checkable,\n    disabled,\n    expandAll,\n    expandLevel,\n    expandMutex,\n    expandParent,\n    keys,\n    lazy,\n    load,\n    store,\n    valueMode,\n  ]);\n\n  useUpdateEffect(() => {\n    if (Array.isArray(value)) {\n      store.replaceChecked(value);\n    }\n  }, [store, value, data]);\n\n  useUpdateEffect(() => {\n    if (Array.isArray(expanded)) {\n      const expandedArr = getExpandedArr(expanded, store);\n      store.replaceExpanded(expandedArr);\n    }\n  }, [expanded, store]);\n\n  useUpdateEffect(() => {\n    if (Array.isArray(actived)) {\n      store.replaceActived(actived);\n    }\n  }, [actived, store]);\n\n  useUpdateEffect(() => {\n    store.setConfig({\n      filter,\n    });\n    store.updateAll();\n  }, [filter, store]);\n\n  return storeRef.current;\n}\n"],"names":["useStore","props","refresh","storeRef","useRef","_useState","useState","_useState2","_slicedToArray","filterChanged","toggleFilterChanged","_useState3","_useState4","prevExpanded","changePrevExpanded","data","keys","expandAll","expandParent","expanded","expandLevel","expandMutex","activable","activeMultiple","actived","disabled","draggable","checkable","value","checkStrictly","load","lazy","valueMode","filter","onLoad","_props$allowFoldNodeO","allowFoldNodeOnFilter","preFilter","usePrevious","useEffect","JSON","stringify","expandFilterPath","store","current","getExpanded","pathValues","allNodes","getNodes","forEach","node","vmIsLocked","push","setExpanded","replaceExpanded","handleUpdate","usePersistFn","getExpandedArr","arr","expandedMap","Map","val","set","getNode","getParents","tn","Array","from","createStore","TreeStore","info","getModel","onUpdate","list","cloneDeep","isArray","append","refreshNodes","setChecked","expandedArr","setActived","useUpdateEffect","checked","getChecked","getActived","removeAll","setConfig","refreshState","replaceChecked","replaceActived","updateAll"],"mappings":"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"}