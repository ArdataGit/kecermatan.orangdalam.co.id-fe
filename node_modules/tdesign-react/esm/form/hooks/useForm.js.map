{"version":3,"file":"useForm.js","sources":["../../../src/form/hooks/useForm.ts"],"sourcesContent":["import { useState, useRef } from 'react';\nimport type { NamePath } from '../type';\nimport type { WatchCallBack, InternalHooks, InternalFormInstance, Store } from './interface';\nimport log from '../../_common/js/log';\n\nexport const HOOK_MARK = 'TD_FORM_INTERNAL_HOOKS';\n\n// TODO 后续将所有实例函数迁移到 FormStore 内统一管理\nclass FormStore {\n  private prevStore: Store = {};\n\n  private store: Store = {};\n\n  private forceRootUpdate: () => void;\n\n  constructor(forceReRender) {\n    this.forceRootUpdate = forceReRender;\n  }\n\n  public taskQueue: any[] = [];\n\n  public flashQueue = () => {\n    this.taskQueue.forEach((task) => {\n      this[task.name].apply(this, [...task.args]);\n    });\n    this.taskQueue = [];\n  };\n\n  public getForm = (): InternalFormInstance => ({\n    submit: (...args) => {\n      this.taskQueue.push({ args, name: 'submit' });\n    },\n    reset: (...args) => {\n      this.taskQueue.push({ args, name: 'reset' });\n    },\n    validate: null,\n    validateOnly: null,\n    clearValidate: (...args) => {\n      this.taskQueue.push({ args, name: 'clearValidate' });\n    },\n    setFields: (...args) => {\n      this.taskQueue.push({ args, name: 'setFields' });\n    },\n    setFieldsValue: (...args) => {\n      this.taskQueue.push({ args, name: 'setFieldsValue' });\n    },\n    setValidateMessage: (...args) => {\n      this.taskQueue.push({ args, name: 'setValidateMessage' });\n    },\n    getFieldValue: null,\n    getFieldsValue: null,\n    _init: true,\n\n    getInternalHooks: this.getInternalHooks,\n  });\n\n  private getInternalHooks = (key: string): InternalHooks | null => {\n    if (key === HOOK_MARK) {\n      return {\n        setForm: (formInstance) => {\n          Object.keys(formInstance).forEach((key) => {\n            this[key] = formInstance[key];\n          });\n        },\n        flashQueue: this.flashQueue,\n        notifyWatch: this.notifyWatch,\n        registerWatch: this.registerWatch,\n        getPrevStore: () => this.prevStore,\n        setPrevStore: (store: object) => {\n          this.prevStore = store;\n        },\n      };\n    }\n\n    log.warn('Form', '`getInternalHooks` is internal usage. Should not call directly.');\n    return null;\n  };\n\n  private watchList: WatchCallBack[] = [];\n\n  private registerWatch: InternalHooks['registerWatch'] = (callback) => {\n    this.watchList.push(callback);\n\n    return () => {\n      this.watchList = this.watchList.filter((fn) => fn !== callback);\n    };\n  };\n\n  private notifyWatch = (namePath: NamePath = []) => {\n    // No need to cost perf when nothing need to watch\n    if (this.watchList.length) {\n      // @ts-ignore\n      const values = this.getFieldsValue?.([namePath]);\n\n      this.watchList.forEach((callback) => {\n        callback(values, namePath);\n      });\n    }\n  };\n}\n\nexport default function useForm(form?: InternalFormInstance) {\n  const formRef = useRef<InternalFormInstance>(Object.create({}));\n  const [, forceUpdate] = useState({});\n\n  // eslint-disable-next-line\n  if (!formRef.current._init) {\n    if (form) {\n      formRef.current = form;\n    } else {\n      // Create a new FormStore if not provided\n      const forceReRender = () => {\n        forceUpdate({});\n      };\n\n      const formStore: FormStore = new FormStore(forceReRender);\n\n      formRef.current = formStore.getForm();\n    }\n  }\n\n  return [formRef.current];\n}\n"],"names":["HOOK_MARK","FormStore","_createClass","forceReRender","_this","_classCallCheck","_defineProperty","taskQueue","forEach","task","name","apply","_toConsumableArray","args","submit","_len","arguments","length","Array","_key","push","reset","_len2","_key2","validate","validateOnly","clearValidate","_len3","_key3","setFields","_len4","_key4","setFieldsValue","_len5","_key5","setValidateMessage","_len6","_key6","getFieldValue","getFieldsValue","_init","getInternalHooks","key","setForm","formInstance","Object","keys","flashQueue","notifyWatch","registerWatch","getPrevStore","prevStore","setPrevStore","store","log","warn","callback","watchList","filter","fn","namePath","undefined","_this$getFieldsValue","values","call","forceRootUpdate","useForm","form","formRef","useRef","create","_useState","useState","_useState2","_slicedToArray","forceUpdate","current","formStore","getForm"],"mappings":"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"}