/**
 * tdesign v1.7.1
 * (c) 2024 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-ff9a5a06.js');
var slicedToArray = require('../_chunks/dep-c86b4e2f.js');
var React = require('react');
var reactTransitionGroup = require('react-transition-group');
var isFunction = require('../_chunks/dep-7d38d5e1.js');
var debounce = require('../_chunks/dep-8c3144cb.js');
var classNames = require('classnames');
var reactPopper = require('react-popper');
var hooks_useControlled = require('../hooks/useControlled.js');
var _util_useAnimation = require('../_util/useAnimation.js');
var hooks_useConfig = require('../hooks/useConfig.js');
var common_Portal = require('../common/Portal.js');
var popup_hooks_useTrigger = require('./hooks/useTrigger.js');
var popup_utils_ref = require('./utils/ref.js');
var popup_utils_transition = require('./utils/transition.js');
var _util_useMutationObserver = require('../_util/useMutationObserver.js');
var _util_useWindowSize = require('../_util/useWindowSize.js');
var popup_defaultProps = require('./defaultProps.js');
var hooks_useDefaultProps = require('../hooks/useDefaultProps.js');
require('../_chunks/dep-2e4b81d6.js');
require('../_chunks/dep-a4fb1294.js');
require('../_chunks/dep-68d6ca4f.js');
require('../_chunks/dep-59101a1c.js');
require('../_chunks/dep-5ed3b3ae.js');
require('../_chunks/dep-6b656ad5.js');
require('../_chunks/dep-f70c56e2.js');
require('../_chunks/dep-315a4a2b.js');
require('../_chunks/dep-58dbd853.js');
require('../_chunks/dep-c0841a72.js');
require('../_chunks/dep-174c24e3.js');
require('../_chunks/dep-04f46890.js');
require('../_chunks/dep-e7a0e8b4.js');
require('../_util/noop.js');
require('../config-provider/ConfigContext.js');
require('../_chunks/dep-be14ef0c.js');
require('../_chunks/dep-d9f1fc69.js');
require('../_chunks/dep-4a411278.js');
require('../_chunks/dep-9171afa5.js');
require('../_chunks/dep-8bb91473.js');
require('../_chunks/dep-2caefa8e.js');
require('../_chunks/dep-3076c3e7.js');
require('../_chunks/dep-14dd074a.js');
require('../_chunks/dep-d93c04ca.js');
require('../_chunks/dep-2a8c4619.js');
require('../_chunks/dep-1c485dd2.js');
require('../_chunks/dep-6bae679a.js');
require('../_chunks/dep-b54caa56.js');
require('../_chunks/dep-33b4bb35.js');
require('../_chunks/dep-bd15ffce.js');
require('../_chunks/dep-7b996f28.js');
require('../_common/js/global-config/locale/zh_CN.js');
require('../_chunks/dep-a4ac3164.js');
require('dayjs');
require('../_common/js/global-config/default-config.js');
require('react-dom');
require('../_util/dom.js');
require('raf');
require('../_chunks/dep-ed73cb23.js');
require('../_util/easing.js');
require('react-is');
require('../_util/composeRefs.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { defineProperty._defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
var Popup = /*#__PURE__*/React.forwardRef(function (originalProps, ref) {
  var props = hooks_useDefaultProps["default"](originalProps, popup_defaultProps.popupDefaultProps);
  var trigger = props.trigger,
    content = props.content,
    placement = props.placement,
    attach = props.attach,
    showArrow = props.showArrow,
    destroyOnClose = props.destroyOnClose,
    overlayClassName = props.overlayClassName,
    overlayInnerClassName = props.overlayInnerClassName,
    overlayStyle = props.overlayStyle,
    overlayInnerStyle = props.overlayInnerStyle,
    triggerElement = props.triggerElement,
    _props$children = props.children,
    children = _props$children === void 0 ? triggerElement : _props$children,
    disabled = props.disabled,
    zIndex = props.zIndex,
    onScroll = props.onScroll,
    onScrollToBottom = props.onScrollToBottom,
    expandAnimation = props.expandAnimation,
    delay = props.delay,
    hideEmptyPopup = props.hideEmptyPopup,
    popperOptions = props.popperOptions,
    updateScrollTop = props.updateScrollTop;
  var _useConfig = hooks_useConfig["default"](),
    classPrefix = _useConfig.classPrefix;
  var _useAnimation = _util_useAnimation["default"](),
    keepExpand = _useAnimation.keepExpand,
    keepFade = _useAnimation.keepFade;
  var _useWindowSize = _util_useWindowSize["default"](),
    windowHeight = _useWindowSize.height,
    windowWidth = _useWindowSize.width;
  var _useControlled = hooks_useControlled["default"](props, "visible", props.onVisibleChange),
    _useControlled2 = slicedToArray._slicedToArray(_useControlled, 2),
    visible = _useControlled2[0],
    onVisibleChange = _useControlled2[1];
  var _useState = React.useState(null),
    _useState2 = slicedToArray._slicedToArray(_useState, 2),
    popupElement = _useState2[0],
    setPopupElement = _useState2[1];
  var triggerRef = React.useRef(null);
  var popupRef = React.useRef(null);
  var portalRef = React.useRef(null);
  var contentRef = React.useRef(null);
  var popperRef = React.useRef(null);
  var DEFAULT_TRANSITION_TIMEOUT = 180;
  var showOverlay = React.useMemo(function () {
    if (hideEmptyPopup && !content) return false;
    return visible || popupElement;
  }, [hideEmptyPopup, content, visible, popupElement]);
  var popperPlacement = React.useMemo(function () {
    return placement.replace(/-(left|top)$/, "-start").replace(/-(right|bottom)$/, "-end");
  }, [placement]);
  var _useTrigger = popup_hooks_useTrigger["default"]({
      triggerRef: triggerRef,
      content: content,
      disabled: disabled,
      trigger: trigger,
      visible: visible,
      delay: delay,
      onVisibleChange: onVisibleChange
    }),
    getTriggerNode = _useTrigger.getTriggerNode,
    getPopupProps = _useTrigger.getPopupProps,
    getTriggerDom = _useTrigger.getTriggerDom;
  popperRef.current = reactPopper.usePopper(popup_utils_ref.getRefDom(triggerRef), popupElement, _objectSpread({
    placement: popperPlacement
  }, popperOptions));
  var _popperRef$current = popperRef.current,
    styles = _popperRef$current.styles,
    attributes = _popperRef$current.attributes;
  var triggerNode = isFunction.isFunction_1(children) ? getTriggerNode(children({
    visible: visible
  })) : getTriggerNode(children);
  var updateTimeRef = React.useRef(null);
  _util_useMutationObserver["default"](popup_utils_ref.getRefDom(triggerRef), function () {
    clearTimeout(updateTimeRef.current);
    updateTimeRef.current = setTimeout(function () {
      var _popperRef$current2, _popperRef$current2$u;
      return (_popperRef$current2 = popperRef.current) === null || _popperRef$current2 === void 0 || (_popperRef$current2$u = _popperRef$current2.update) === null || _popperRef$current2$u === void 0 ? void 0 : _popperRef$current2$u.call(_popperRef$current2);
    }, 0);
  });
  React.useEffect(function () {
    return function () {
      return clearTimeout(updateTimeRef.current);
    };
  }, []);
  React.useEffect(function () {
    requestAnimationFrame(function () {
      var _popperRef$current3, _popperRef$current3$u;
      return (_popperRef$current3 = popperRef.current) === null || _popperRef$current3 === void 0 || (_popperRef$current3$u = _popperRef$current3.update) === null || _popperRef$current3$u === void 0 ? void 0 : _popperRef$current3$u.call(_popperRef$current3);
    });
  }, [visible, content, windowHeight, windowWidth]);
  React.useEffect(function () {
    if (!triggerRef.current) triggerRef.current = getTriggerDom();
    if (visible) {
      updateScrollTop === null || updateScrollTop === void 0 || updateScrollTop(contentRef.current);
    }
  }, [visible, updateScrollTop, getTriggerDom]);
  function handleExited() {
    !destroyOnClose && popupElement && (popupElement.style.display = "none");
  }
  function handleEnter() {
    !destroyOnClose && popupElement && (popupElement.style.display = "block");
  }
  function handleScroll(e) {
    onScroll === null || onScroll === void 0 || onScroll({
      e: e
    });
    var debounceOnScrollBottom = debounce.debounce_1(function (e2) {
      return onScrollToBottom === null || onScrollToBottom === void 0 ? void 0 : onScrollToBottom({
        e: e2
      });
    }, 100);
    var _e$target = e.target,
      scrollTop = _e$target.scrollTop,
      clientHeight = _e$target.clientHeight,
      scrollHeight = _e$target.scrollHeight;
    if (clientHeight + Math.floor(scrollTop) === scrollHeight) {
      debounceOnScrollBottom(e);
    }
  }
  function getOverlayStyle(overlayStyle2) {
    if (popup_utils_ref.getRefDom(triggerRef) && popupRef.current && typeof overlayStyle2 === "function") {
      return _objectSpread({}, overlayStyle2(popup_utils_ref.getRefDom(triggerRef), popupRef.current));
    }
    return _objectSpread({}, overlayStyle2);
  }
  var overlay = showOverlay && /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, {
    appear: true,
    "in": visible,
    timeout: DEFAULT_TRANSITION_TIMEOUT,
    nodeRef: portalRef,
    unmountOnExit: destroyOnClose,
    onEnter: handleEnter,
    onExited: handleExited
  }, /* @__PURE__ */React__default["default"].createElement(common_Portal["default"], {
    triggerNode: popup_utils_ref.getRefDom(triggerRef),
    attach: attach,
    ref: portalRef
  }, /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, _objectSpread({
    appear: true,
    timeout: 0,
    "in": visible,
    nodeRef: popupRef
  }, popup_utils_transition.getTransitionParams({
    classPrefix: classPrefix,
    fadeAnimation: keepFade,
    expandAnimation: expandAnimation && keepExpand
  })), /* @__PURE__ */React__default["default"].createElement("div", _objectSpread(_objectSpread({
    ref: function ref(node) {
      if (node) {
        popupRef.current = node;
        setPopupElement(node);
      }
    },
    style: _objectSpread(_objectSpread({}, styles.popper), {}, {
      zIndex: zIndex
    }, getOverlayStyle(overlayStyle)),
    className: classNames__default["default"]("".concat(classPrefix, "-popup"), overlayClassName)
  }, attributes.popper), getPopupProps()), /* @__PURE__ */React__default["default"].createElement("div", {
    ref: contentRef,
    className: classNames__default["default"]("".concat(classPrefix, "-popup__content"), defineProperty._defineProperty({}, "".concat(classPrefix, "-popup__content--arrow"), showArrow), overlayInnerClassName),
    style: getOverlayStyle(overlayInnerStyle),
    onScroll: handleScroll
  }, content, showArrow ? /* @__PURE__ */React__default["default"].createElement("div", {
    style: styles.arrow,
    className: "".concat(classPrefix, "-popup__arrow")
  }) : null)))));
  React.useImperativeHandle(ref, function () {
    return {
      getPopper: function getPopper() {
        return popperRef.current;
      },
      getPopupElement: function getPopupElement() {
        return popupRef.current;
      },
      getPortalElement: function getPortalElement() {
        return portalRef.current;
      },
      getPopupContentElement: function getPopupContentElement() {
        return contentRef.current;
      },
      setVisible: function setVisible(visible2) {
        return onVisibleChange(visible2, {
          trigger: "document"
        });
      }
    };
  });
  return /* @__PURE__ */React__default["default"].createElement(React__default["default"].Fragment, null, triggerNode, overlay);
});
Popup.displayName = "Popup";

exports["default"] = Popup;
//# sourceMappingURL=Popup.js.map
