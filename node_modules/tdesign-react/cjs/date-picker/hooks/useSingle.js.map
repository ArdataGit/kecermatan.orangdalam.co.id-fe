{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-react';\nimport dayjs from 'dayjs';\nimport classNames from 'classnames';\nimport useConfig from '../../hooks/useConfig';\nimport useGlobalIcon from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps } from '../type';\nimport {\n  isValidDate,\n  formatDate,\n  formatTime,\n  getDefaultFormat,\n  parseToDayjs,\n} from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\nimport type { TdPopupProps } from '../../popup/type';\n\nexport default function useSingleInput(props: TdDatePickerProps) {\n  const { classPrefix, datePicker: globalDatePickerConfig } = useConfig();\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const name = `${classPrefix}-date-picker`;\n\n  const { format, valueType, timeFormat } = getDefaultFormat({\n    mode: props.mode,\n    format: props.format,\n    valueType: props.valueType,\n    enableTimePicker: props.enableTimePicker,\n  });\n\n  const inputRef = useRef<HTMLInputElement>();\n\n  const { value, onChange, time, setTime, month, setMonth, year, setYear, cacheValue, setCacheValue } =\n    useSingleValue(props);\n\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [isHoverCell, setIsHoverCell] = useState(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const [inputValue, setInputValue] = useState(formatDate(value, { format }));\n\n  // input 设置\n  const inputProps = {\n    ...props.inputProps,\n    ref: inputRef,\n    size: props.size,\n    clearable: props.clearable,\n    prefixIcon: props.prefixIcon,\n    readonly: !props.allowInput,\n    placeholder: props.placeholder ?? globalDatePickerConfig.placeholder[props.mode],\n    suffixIcon: props.suffixIcon ?? <CalendarIcon />,\n    className: classNames({\n      [`${name}__input--placeholder`]: isHoverCell,\n    }),\n    onClear: ({ e }) => {\n      e.stopPropagation();\n      setPopupVisible(false);\n      onChange('', { dayjsValue: dayjs(), trigger: 'clear' });\n    },\n    onBlur: (val: string, { e }) => {\n      props.onBlur?.({ value: val, e });\n    },\n    onFocus: (_: string, { e }) => {\n      props.onFocus?.({ value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      setInputValue(val);\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, format)) return;\n      setCacheValue(val);\n      const newMonth = parseToDayjs(val, format).month();\n      const newYear = parseToDayjs(val, format).year();\n      const newTime = formatTime(val, format, timeFormat, props.defaultTime);\n      !Number.isNaN(newYear) && setYear(newYear);\n      !Number.isNaN(newMonth) && setMonth(newMonth);\n      !Number.isNaN(newTime) && setTime(newTime);\n    },\n    onEnter: (val: string) => {\n      if (!val) {\n        onChange('', { dayjsValue: dayjs(), trigger: 'enter' });\n        setPopupVisible(false);\n        return;\n      }\n\n      if (!isValidDate(val, format) && !isValidDate(value, format)) return;\n\n      setPopupVisible(false);\n      if (isValidDate(val, format)) {\n        onChange(formatDate(val, { format, targetFormat: valueType }), {\n          dayjsValue: parseToDayjs(val, format),\n          trigger: 'enter',\n        });\n      } else if (isValidDate(value, format)) {\n        setInputValue(formatDate(value, { format }));\n      } else {\n        setInputValue('');\n      }\n    },\n  };\n\n  // popup 设置\n  const popupProps = {\n    expandAnimation: true,\n    ...props.popupProps,\n    trigger: 'mousedown' as TdPopupProps['trigger'],\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: classNames(props.popupProps?.overlayClassName, `${name}__panel-container`),\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (props.disabled) return;\n      // 这里劫持了进一步向 popup 传递的 onVisibleChange 事件，为了保证可以在 Datepicker 中使用 popupProps.onVisibleChange，故此处理\n      props.popupProps?.onVisibleChange?.(visible, context);\n      if (context.trigger === 'trigger-element-mousedown') {\n        return setPopupVisible(true);\n      }\n      setPopupVisible(visible);\n    },\n  };\n\n  // 输入框响应 value 变化\n  useEffect(() => {\n    if (!value) {\n      setInputValue('');\n      return;\n    }\n    if (!isValidDate(value, format)) return;\n\n    setInputValue(formatDate(value, { format }));\n    // eslint-disable-next-line\n  }, [value]);\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    onChange,\n    setYear,\n    setMonth,\n    setTime,\n    setIsHoverCell,\n    setInputValue,\n    setPopupVisible,\n    setCacheValue,\n  };\n}\n"],"names":["useSingleInput","props","_props$placeholder","_props$suffixIcon","_props$popupProps$ove","_props$popupProps","_props$popupProps2","_useConfig","useConfig","classPrefix","globalDatePickerConfig","datePicker","_useGlobalIcon","useGlobalIcon","CalendarIcon","TdCalendarIcon","name","_getDefaultFormat","getDefaultFormat","mode","format","valueType","enableTimePicker","timeFormat","inputRef","useRef","_useSingleValue","useSingleValue","value","onChange","time","setTime","month","setMonth","year","setYear","cacheValue","setCacheValue","_useState","useState","_useState2","_slicedToArray","popupVisible","setPopupVisible","_useState3","_useState4","isHoverCell","setIsHoverCell","_useState5","formatDate","_useState6","inputValue","setInputValue","inputProps","_objectSpread","ref","size","clearable","prefixIcon","readonly","allowInput","placeholder","suffixIcon","React","createElement","className","classNames","_defineProperty","concat","onClear","_ref","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","_ref2","_props$onBlur","call","onFocus","_","_ref3","_props$onFocus","isValidDate","newMonth","parseToDayjs","newYear","newTime","formatTime","defaultTime","Number","isNaN","onEnter","targetFormat","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","context","_props$popupProps3","_props$popupProps3$on","disabled","useEffect"],"mappings":"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"}