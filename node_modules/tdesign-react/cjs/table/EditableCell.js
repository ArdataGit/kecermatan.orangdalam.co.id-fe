/**
 * tdesign v1.7.1
 * (c) 2024 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _typeof = require('../_chunks/dep-68d6ca4f.js');
var defineProperty = require('../_chunks/dep-ff9a5a06.js');
var toArray = require('../_chunks/dep-d097e6a6.js');
var slicedToArray = require('../_chunks/dep-c86b4e2f.js');
var React = require('react');
var get = require('../_chunks/dep-7c29b5a1.js');
var set = require('../_chunks/dep-9f572ddd.js');
var isFunction = require('../_chunks/dep-7d38d5e1.js');
var cloneDeep = require('../_chunks/dep-63c6d023.js');
var tdesignIconsReact = require('tdesign-icons-react');
var classNames = require('classnames');
var hooks_useGlobalIcon = require('../hooks/useGlobalIcon.js');
var table_Cell = require('./Cell.js');
var form_formModel = require('../form/formModel.js');
var _common_js_log_log = require('../_common/js/log/log.js');
var hooks_useConfig = require('../hooks/useConfig.js');
require('../_chunks/dep-987bfa39.js');
require('../_chunks/dep-2e4b81d6.js');
require('../_chunks/dep-55437cd3.js');
require('../_chunks/dep-e7a0e8b4.js');
require('../_chunks/dep-f70c56e2.js');
require('../_chunks/dep-a4fb1294.js');
require('../_chunks/dep-59101a1c.js');
require('../_chunks/dep-315a4a2b.js');
require('../_chunks/dep-4a411278.js');
require('../_chunks/dep-9171afa5.js');
require('../_chunks/dep-5ed3b3ae.js');
require('../_chunks/dep-8bb91473.js');
require('../_chunks/dep-04f46890.js');
require('../_chunks/dep-2a42b204.js');
require('../_chunks/dep-d93c04ca.js');
require('../_chunks/dep-2a8c4619.js');
require('../_chunks/dep-6bae679a.js');
require('../_chunks/dep-2a862cb7.js');
require('../_chunks/dep-d9f1fc69.js');
require('../_chunks/dep-2caefa8e.js');
require('../_chunks/dep-3076c3e7.js');
require('../_chunks/dep-14dd074a.js');
require('../_chunks/dep-1c485dd2.js');
require('../_chunks/dep-e38461b1.js');
require('../_chunks/dep-519d75c6.js');
require('../_chunks/dep-8685fcba.js');
require('../_chunks/dep-66fdf975.js');
require('../_chunks/dep-ef8352c0.js');
require('../_chunks/dep-1dbff57a.js');
require('../config-provider/ConfigContext.js');
require('../_chunks/dep-be14ef0c.js');
require('../_chunks/dep-b54caa56.js');
require('../_chunks/dep-33b4bb35.js');
require('../_chunks/dep-bd15ffce.js');
require('../_chunks/dep-7b996f28.js');
require('../_common/js/global-config/locale/zh_CN.js');
require('../_chunks/dep-a4ac3164.js');
require('dayjs');
require('../_common/js/global-config/default-config.js');
require('./Ellipsis.js');
require('../_util/dom.js');
require('raf');
require('../_chunks/dep-ed73cb23.js');
require('../_util/easing.js');
require('../tooltip/index.js');
require('../tooltip/Tooltip.js');
require('../_chunks/dep-d6b83811.js');
require('../popup/index.js');
require('../popup/Popup.js');
require('react-transition-group');
require('../_chunks/dep-8c3144cb.js');
require('../_chunks/dep-6b656ad5.js');
require('react-popper');
require('../hooks/useControlled.js');
require('../_chunks/dep-58dbd853.js');
require('../_chunks/dep-c0841a72.js');
require('../_chunks/dep-174c24e3.js');
require('../_util/noop.js');
require('../_util/useAnimation.js');
require('../common/Portal.js');
require('react-dom');
require('../popup/hooks/useTrigger.js');
require('react-is');
require('../popup/utils/ref.js');
require('../_util/composeRefs.js');
require('../popup/utils/transition.js');
require('../_util/useMutationObserver.js');
require('../_util/useWindowSize.js');
require('../popup/defaultProps.js');
require('../hooks/useDefaultProps.js');
require('../popup/PopupPlugin.js');
require('../_chunks/dep-f23ba698.js');
require('@popperjs/core');
require('../_util/react-render.js');
require('../tooltip/defaultProps.js');
require('../tooltip/TooltipLite.js');
require('../_util/useSwitch.js');
require('../_util/usePersistFn.js');
require('../_common/js/utils/getPosition.js');
require('../hooks/useDebounce.js');
require('./hooks/useFixed.js');
require('../_chunks/dep-e0e28478.js');
require('../_chunks/dep-64e9d9c5.js');
require('../_chunks/dep-ef5f8027.js');
require('../_chunks/dep-8cdeb4e0.js');
require('../_chunks/dep-51813e64.js');
require('../_chunks/dep-77cbeae0.js');
require('../_chunks/dep-f5d44fc6.js');
require('../_chunks/dep-68af137c.js');
require('../_chunks/dep-f74209a9.js');
require('../_common/js/utils/helper.js');
require('../_chunks/dep-3f013aa5.js');
require('../_chunks/dep-0f313135.js');
require('../_chunks/dep-0bcf83a3.js');
require('../_common/js/utils/getScrollbarWidth.js');
require('../hooks/usePrevious.js');
require('./utils.js');
require('../_chunks/dep-69e436c9.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { defineProperty._defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
var EditableCell = function EditableCell(props) {
  var _col$edit, _props$col$edit, _col$edit6, _errorList$, _col$edit7, _errorList$2;
  var row = props.row,
    col = props.col,
    colIndex = props.colIndex,
    rowIndex = props.rowIndex,
    errors = props.errors,
    editable = props.editable,
    tableBaseClass = props.tableBaseClass;
  var _useGlobalIcon = hooks_useGlobalIcon["default"]({
      Edit1Icon: tdesignIconsReact.Edit1Icon
    }),
    Edit1Icon = _useGlobalIcon.Edit1Icon;
  var tableEditableCellRef = React.useRef(null);
  var isKeepEditMode = Boolean((_col$edit = col.edit) === null || _col$edit === void 0 ? void 0 : _col$edit.keepEditMode);
  var _useState = React.useState(isKeepEditMode || ((_props$col$edit = props.col.edit) === null || _props$col$edit === void 0 ? void 0 : _props$col$edit.defaultEditable) || false),
    _useState2 = slicedToArray._slicedToArray(_useState, 2),
    isEdit = _useState2[0],
    setIsEdit = _useState2[1];
  var _useState3 = React.useState(),
    _useState4 = slicedToArray._slicedToArray(_useState3, 2),
    editValue = _useState4[0],
    setEditValue = _useState4[1];
  var _useState5 = React.useState([]),
    _useState6 = slicedToArray._slicedToArray(_useState5, 2),
    errorList = _useState6[0],
    setErrorList = _useState6[1];
  var _useConfig = hooks_useConfig["default"](),
    classPrefix = _useConfig.classPrefix;
  React.useEffect(function () {
    if (isKeepEditMode) {
      setIsEdit(true);
    }
  }, [isKeepEditMode]);
  var getCurrentRow = function getCurrentRow(row2, colKey, value) {
    if (!colKey) return row2;
    var _ref = colKey.split(".") || [],
      _ref2 = toArray._toArray(_ref),
      firstKey = _ref2[0],
      restKeys = _ref2.slice(1);
    var newRow = _objectSpread({}, row2);
    if (restKeys.length) {
      newRow[firstKey] = cloneDeep.cloneDeep_1(row2[firstKey]);
      set.set_1(newRow[firstKey], restKeys.join("."), value);
    } else {
      set.set_1(newRow, colKey, value);
    }
    return newRow;
  };
  var cellParams = React.useMemo(function () {
    return {
      col: col,
      row: row,
      colIndex: colIndex,
      rowIndex: rowIndex
    };
  }, [col, row, colIndex, rowIndex]);
  var cellValue = React.useMemo(function () {
    return get.get_1(row, col.colKey);
  }, [row, col.colKey]);
  var currentRow = React.useMemo(function () {
    return getCurrentRow(row, col.colKey, editValue);
  }, [col.colKey, editValue, row]);
  var updateEditedCellValue = function updateEditedCellValue(val) {
    setEditValue(val);
  };
  var editOnListeners = React.useMemo(function () {
    var _col$edit2, _col$edit2$on;
    return ((_col$edit2 = col.edit) === null || _col$edit2 === void 0 || (_col$edit2$on = _col$edit2.on) === null || _col$edit2$on === void 0 ? void 0 : _col$edit2$on.call(_col$edit2, _objectSpread(_objectSpread({}, cellParams), {}, {
      editedRow: currentRow,
      updateEditedCellValue: updateEditedCellValue
    }))) || {};
  }, [cellParams, currentRow]);
  var cellNode = React.useMemo(function () {
    var node = table_Cell.renderCell({
      row: currentRow,
      col: _objectSpread(_objectSpread({}, col), {}, {
        cell: props.oldCell
      }),
      rowIndex: props.rowIndex,
      colIndex: props.colIndex
    }, {
      cellEmptyContent: props.cellEmptyContent
    });
    return node;
  }, [col, currentRow, props.cellEmptyContent, props.colIndex, props.oldCell, props.rowIndex]);
  var componentProps = React.useMemo(function () {
    var _edit$abortEditOnEven;
    var edit = col.edit;
    if (!edit) return {};
    var editProps = isFunction.isFunction_1(edit.props) ? edit.props(_objectSpread(_objectSpread({}, cellParams), {}, {
      editedRow: currentRow,
      updateEditedCellValue: updateEditedCellValue
    })) : _objectSpread({}, edit.props);
    delete editProps.onChange;
    delete editProps.value;
    (_edit$abortEditOnEven = edit.abortEditOnEvent) === null || _edit$abortEditOnEven === void 0 || _edit$abortEditOnEven.forEach(function (item) {
      delete editProps[item];
    });
    return editProps;
  }, [currentRow, cellParams, col]);
  var isAbortEditOnChange = React.useMemo(function () {
    var _edit$abortEditOnEven2;
    var edit = col.edit;
    if (!edit) return false;
    return Boolean((_edit$abortEditOnEven2 = edit.abortEditOnEvent) === null || _edit$abortEditOnEven2 === void 0 ? void 0 : _edit$abortEditOnEven2.includes("onChange"));
  }, [col]);
  var validateEdit = function validateEdit(trigger, newVal) {
    return new Promise(function (resolve) {
      var params = {
        result: [_objectSpread(_objectSpread({}, cellParams), {}, {
          errorList: [],
          value: newVal
        })],
        trigger: trigger
      };
      var rules = isFunction.isFunction_1(col.edit.rules) ? col.edit.rules(cellParams) : col.edit.rules;
      if (!col.edit || !rules || !rules.length) {
        var _props$onValidate;
        (_props$onValidate = props.onValidate) === null || _props$onValidate === void 0 || _props$onValidate.call(props, params);
        resolve(true);
        return;
      }
      form_formModel.validate(newVal, rules).then(function (result) {
        var _props$onValidate2;
        var list = result === null || result === void 0 ? void 0 : result.filter(function (t) {
          return !t.result;
        });
        params.result[0].errorList = list;
        (_props$onValidate2 = props.onValidate) === null || _props$onValidate2 === void 0 || _props$onValidate2.call(props, params);
        if (!list || !list.length) {
          setErrorList([]);
          resolve(true);
        } else {
          setErrorList(list);
          resolve(list);
        }
      });
    });
  };
  var isSame = function isSame(a, b) {
    if (_typeof._typeof(a) === "object" && _typeof._typeof(b) === "object") {
      return JSON.stringify(a) === JSON.stringify(b);
    }
    return a === b;
  };
  var updateAndSaveAbort = function updateAndSaveAbort(outsideAbortEvent, eventName) {
    for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {
      args[_key - 2] = arguments[_key];
    }
    validateEdit("self", args[0].value).then(function (result) {
      var _editOnListeners$even;
      if (result !== true) return;
      var oldValue = get.get_1(row, col.colKey);
      if (!isSame(args[0].value, oldValue)) {
        setEditValue(oldValue);
        outsideAbortEvent === null || outsideAbortEvent === void 0 || outsideAbortEvent.apply(void 0, args);
      }
      (_editOnListeners$even = editOnListeners[eventName]) === null || _editOnListeners$even === void 0 || _editOnListeners$even.call(editOnListeners, args[2]);
      var timer = setTimeout(function () {
        if (!isKeepEditMode) {
          setIsEdit(false);
        }
        setErrorList([]);
        clearTimeout(timer);
      }, 0);
    });
  };
  var listeners = React.useMemo(function () {
    var _edit$abortEditOnEven3;
    var edit = col.edit;
    var isCellEditable = props.editable === void 0;
    if (!isEdit || !isCellEditable) return;
    if (!(edit !== null && edit !== void 0 && (_edit$abortEditOnEven3 = edit.abortEditOnEvent) !== null && _edit$abortEditOnEven3 !== void 0 && _edit$abortEditOnEven3.length)) return {};
    var tListeners = {};
    var outsideAbortEvent = edit === null || edit === void 0 ? void 0 : edit.onEdited;
    edit.abortEditOnEvent.forEach(function (itemEvent) {
      if (itemEvent === "onChange") return;
      tListeners[itemEvent] = function () {
        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
          args[_key2] = arguments[_key2];
        }
        updateAndSaveAbort.apply(void 0, [outsideAbortEvent, itemEvent, _objectSpread(_objectSpread({}, cellParams), {}, {
          value: editValue,
          trigger: itemEvent,
          newRowData: currentRow
        })].concat(args));
      };
    });
    return tListeners;
  }, [col, currentRow, isEdit, props.rowIndex]);
  var onEditChange = function onEditChange(val) {
    var _props$onChange, _props$onRuleChange, _editOnListeners$onCh, _col$edit4;
    setEditValue(val);
    var params = _objectSpread(_objectSpread({}, cellParams), {}, {
      value: val,
      editedRow: set.set_1(_objectSpread({}, props.row), props.col.colKey, val)
    });
    (_props$onChange = props.onChange) === null || _props$onChange === void 0 || _props$onChange.call(props, params);
    (_props$onRuleChange = props.onRuleChange) === null || _props$onRuleChange === void 0 || _props$onRuleChange.call(props, params);
    (_editOnListeners$onCh = editOnListeners.onChange) === null || _editOnListeners$onCh === void 0 || _editOnListeners$onCh.call(editOnListeners, params);
    var isCellEditable = props.editable === void 0;
    if (isCellEditable && isAbortEditOnChange) {
      var _col$edit3;
      var outsideAbortEvent = (_col$edit3 = col.edit) === null || _col$edit3 === void 0 ? void 0 : _col$edit3.onEdited;
      for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {
        args[_key3 - 1] = arguments[_key3];
      }
      updateAndSaveAbort.apply(void 0, [outsideAbortEvent, "change", {
        value: val,
        trigger: "onChange",
        newRowData: getCurrentRow(currentRow, col.colKey, val),
        rowIndex: props.rowIndex
      }].concat(args));
    }
    if (((_col$edit4 = col.edit) === null || _col$edit4 === void 0 ? void 0 : _col$edit4.validateTrigger) === "change") {
      validateEdit("self", val);
    }
  };
  var documentClickHandler = function documentClickHandler(e) {
    var _e$composedPath;
    if (!col.edit || !col.edit.component) return;
    if (!isEdit) return;
    var path = ((_e$composedPath = e.composedPath) === null || _e$composedPath === void 0 ? void 0 : _e$composedPath.call(e)) || e.path || [];
    var node = path.find(function (node2) {
      var _node2$classList;
      return (_node2$classList = node2.classList) === null || _node2$classList === void 0 ? void 0 : _node2$classList.contains("".concat(classPrefix, "-popup__content"));
    });
    if (node) return;
    var outsideAbortEvent = col.edit.onEdited;
    updateAndSaveAbort(outsideAbortEvent, "", {
      value: editValue,
      trigger: "document",
      newRowData: currentRow,
      rowIndex: props.rowIndex
    });
  };
  React.useEffect(function () {
    setEditValue(cellValue);
  }, [cellValue]);
  React.useEffect(function () {
    if (typeof document === "undefined") return;
    var isCellEditable = props.editable === void 0;
    if (!col.edit || !col.edit.component || !isCellEditable) return;
    if (isEdit) {
      document.addEventListener("click", documentClickHandler);
    } else {
      document.removeEventListener("click", documentClickHandler);
    }
    return function () {
      document.removeEventListener("click", documentClickHandler);
    };
  }, [col.edit, isEdit, editValue]);
  React.useEffect(function () {
    if (props.editable === false) {
      setEditValue(cellValue);
    }
  }, [cellValue, editable]);
  React.useEffect(function () {
    if (props.editable === true) {
      var _props$onRuleChange2;
      (_props$onRuleChange2 = props.onRuleChange) === null || _props$onRuleChange2 === void 0 || _props$onRuleChange2.call(props, _objectSpread(_objectSpread({}, cellParams), {}, {
        value: cellValue,
        editedRow: currentRow || row
      }));
    }
  }, [props.editable, cellValue, row, col, cellParams, currentRow]);
  React.useEffect(function () {
    setErrorList(errors);
  }, [errors]);
  if (props.readonly) {
    return cellNode || null;
  }
  if (props.editable === void 0 && !isEdit || editable === false) {
    var _col$edit5;
    return /* @__PURE__ */React__default["default"].createElement("div", {
      className: classNames__default["default"](tableBaseClass.cellEditable),
      onClick: function onClick(e) {
        setIsEdit(true);
        e.stopPropagation();
        e.nativeEvent.stopImmediatePropagation();
      }
    }, cellNode, ((_col$edit5 = col.edit) === null || _col$edit5 === void 0 ? void 0 : _col$edit5.showEditIcon) !== false && /* @__PURE__ */React__default["default"].createElement(Edit1Icon, null));
  }
  var Component = (_col$edit6 = col.edit) === null || _col$edit6 === void 0 ? void 0 : _col$edit6.component;
  if (!Component) {
    _common_js_log_log["default"].error("Table", "edit.component is required.");
    return null;
  }
  var errorMessage = errorList === null || errorList === void 0 || (_errorList$ = errorList[0]) === null || _errorList$ === void 0 ? void 0 : _errorList$.message;
  var tmpEditOnListeners = _objectSpread({}, editOnListeners);
  delete tmpEditOnListeners.onChange;
  if ((_col$edit7 = col.edit) !== null && _col$edit7 !== void 0 && (_col$edit7 = _col$edit7.abortEditOnEvent) !== null && _col$edit7 !== void 0 && _col$edit7.length) {
    col.edit.abortEditOnEvent.forEach(function (onEventName) {
      if (tmpEditOnListeners[onEventName]) {
        delete tmpEditOnListeners[onEventName];
      }
    });
  }
  return /* @__PURE__ */React__default["default"].createElement("div", {
    className: tableBaseClass.cellEditWrap,
    onClick: function onClick(e) {
      e.stopPropagation();
      e.nativeEvent.stopImmediatePropagation();
    }
  }, /* @__PURE__ */React__default["default"].createElement(Component, _objectSpread(_objectSpread(_objectSpread(_objectSpread({
    ref: tableEditableCellRef,
    status: errorMessage ? (errorList === null || errorList === void 0 || (_errorList$2 = errorList[0]) === null || _errorList$2 === void 0 ? void 0 : _errorList$2.type) || "error" : void 0,
    tips: errorMessage
  }, componentProps), listeners), tmpEditOnListeners), {}, {
    value: editValue,
    onChange: onEditChange
  })));
};
EditableCell.displayName = "EditableCell";

exports["default"] = EditableCell;
//# sourceMappingURL=EditableCell.js.map
