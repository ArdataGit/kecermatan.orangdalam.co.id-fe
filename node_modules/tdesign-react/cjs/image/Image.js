/**
 * tdesign v1.7.1
 * (c) 2024 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-ff9a5a06.js');
var slicedToArray = require('../_chunks/dep-c86b4e2f.js');
var objectWithoutProperties = require('../_chunks/dep-d6b83811.js');
var React = require('react');
var classNames = require('classnames');
var isFunction = require('../_chunks/dep-7d38d5e1.js');
var tdesignIconsReact = require('tdesign-icons-react');
var _common_js_utils_observe = require('../_common/js/utils/observe.js');
var hooks_useConfig = require('../hooks/useConfig.js');
var locale_LocalReceiver = require('../locale/LocalReceiver.js');
var image_defaultProps = require('./defaultProps.js');
var space_index = require('../space/index.js');
var hooks_useGlobalIcon = require('../hooks/useGlobalIcon.js');
var hooks_useDefaultProps = require('../hooks/useDefaultProps.js');
var hooks_useImagePreviewUrl = require('../hooks/useImagePreviewUrl.js');
require('../_chunks/dep-2e4b81d6.js');
require('../_chunks/dep-a4fb1294.js');
require('../_chunks/dep-68d6ca4f.js');
require('../_chunks/dep-59101a1c.js');
require('../_chunks/dep-5ed3b3ae.js');
require('../config-provider/ConfigContext.js');
require('../_chunks/dep-be14ef0c.js');
require('../_chunks/dep-d9f1fc69.js');
require('../_chunks/dep-4a411278.js');
require('../_chunks/dep-9171afa5.js');
require('../_chunks/dep-8bb91473.js');
require('../_chunks/dep-2caefa8e.js');
require('../_chunks/dep-3076c3e7.js');
require('../_chunks/dep-315a4a2b.js');
require('../_chunks/dep-14dd074a.js');
require('../_chunks/dep-d93c04ca.js');
require('../_chunks/dep-2a8c4619.js');
require('../_chunks/dep-1c485dd2.js');
require('../_chunks/dep-e7a0e8b4.js');
require('../_chunks/dep-6bae679a.js');
require('../_chunks/dep-b54caa56.js');
require('../_chunks/dep-33b4bb35.js');
require('../_chunks/dep-bd15ffce.js');
require('../_chunks/dep-7b996f28.js');
require('../_common/js/global-config/locale/zh_CN.js');
require('../_chunks/dep-a4ac3164.js');
require('dayjs');
require('../_common/js/global-config/default-config.js');
require('../space/Space.js');
require('react-is');
require('../space/defaultProps.js');
require('../_common/js/utils/helper.js');
require('../_chunks/dep-987bfa39.js');
require('../_chunks/dep-ed73cb23.js');
require('../_chunks/dep-3f013aa5.js');
require('../_chunks/dep-0f313135.js');
require('../_chunks/dep-0bcf83a3.js');
require('../_common/js/log/log.js');
require('../_common/js/upload/utils.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

var _excluded = ["className", "src", "style", "fit", "position", "shape", "placeholder", "loading", "error", "overlayTrigger", "lazy", "gallery", "overlayContent", "srcset", "fallback", "onLoad", "onError"],
  _excluded2 = ["alt", "referrerpolicy"];
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { defineProperty._defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function isImageValid(src) {
  return new Promise(function (resolve) {
    var img = document.createElement("img");
    img.onerror = function () {
      return resolve(false);
    };
    img.onload = function () {
      return resolve(true);
    };
    img.src = src;
  });
}
var InternalImage = function InternalImage(originalProps, ref) {
  var props = hooks_useDefaultProps["default"](originalProps, image_defaultProps.imageDefaultProps);
  var className = props.className,
    src = props.src,
    style = props.style,
    fit = props.fit,
    position = props.position,
    shape = props.shape,
    placeholder = props.placeholder,
    loading = props.loading,
    error = props.error,
    overlayTrigger = props.overlayTrigger,
    lazy = props.lazy,
    gallery = props.gallery,
    overlayContent = props.overlayContent,
    srcset = props.srcset,
    fallback = props.fallback,
    onLoad = props.onLoad,
    onError = props.onError,
    waitPassRest = objectWithoutProperties._objectWithoutProperties(props, _excluded);
  var alt = waitPassRest.alt,
    referrerpolicy = waitPassRest.referrerpolicy,
    rest = objectWithoutProperties._objectWithoutProperties(waitPassRest, _excluded2);
  var _useConfig = hooks_useConfig["default"](),
    classPrefix = _useConfig.classPrefix;
  var imageRef = React.useRef(null);
  var _useLocaleReceiver = locale_LocalReceiver.useLocaleReceiver("image"),
    _useLocaleReceiver2 = slicedToArray._slicedToArray(_useLocaleReceiver, 2),
    local = _useLocaleReceiver2[0],
    t = _useLocaleReceiver2[1];
  var _useGlobalIcon = hooks_useGlobalIcon["default"]({
      ImageErrorIcon: tdesignIconsReact.ImageErrorIcon,
      ImageIcon: tdesignIconsReact.ImageIcon
    }),
    ImageErrorIcon = _useGlobalIcon.ImageErrorIcon,
    ImageIcon = _useGlobalIcon.ImageIcon;
  React__default["default"].useImperativeHandle(ref, function () {
    return imageRef.current;
  });
  var _useState = React.useState(src),
    _useState2 = slicedToArray._slicedToArray(_useState, 2),
    imageSrc = _useState2[0],
    setImageSrc = _useState2[1];
  React.useEffect(function () {
    var tmpUrl = isFunction.isFunction_1(local.replaceImageSrc) ? local.replaceImageSrc(props) : src;
    if (tmpUrl === imageSrc && imageSrc) return;
    setImageSrc(tmpUrl);
  }, [src, local, props]);
  var _useImagePreviewUrl = hooks_useImagePreviewUrl.useImagePreviewUrl(imageSrc),
    previewUrl = _useImagePreviewUrl.previewUrl;
  var _useState3 = React.useState(!lazy),
    _useState4 = slicedToArray._slicedToArray(_useState3, 2),
    shouldLoad = _useState4[0],
    setShouldLoad = _useState4[1];
  var handleLoadImage = function handleLoadImage() {
    setShouldLoad(true);
  };
  var _useState5 = React.useState(false),
    _useState6 = slicedToArray._slicedToArray(_useState5, 2),
    isLoaded = _useState6[0],
    setIsLoaded = _useState6[1];
  var handleLoad = function handleLoad(e) {
    setIsLoaded(true);
    onLoad === null || onLoad === void 0 || onLoad({
      e: e
    });
  };
  React.useEffect(function () {
    if (!lazy || !(imageRef !== null && imageRef !== void 0 && imageRef.current)) {
      return;
    }
    var observerRefValue = null;
    var io = _common_js_utils_observe["default"](imageRef.current, null, handleLoadImage, 0);
    observerRefValue = imageRef.current;
    return function () {
      observerRefValue && io && io.unobserve(observerRefValue);
    };
  }, [lazy, imageRef]);
  var _useState7 = React.useState(false),
    _useState8 = slicedToArray._slicedToArray(_useState7, 2),
    hasError = _useState8[0],
    setHasError = _useState8[1];
  var isFirstError = React.useRef(false);
  var handleError = function handleError(e) {
    isFirstError.current = true;
    setHasError(true);
    if (fallback) {
      setImageSrc(fallback);
      setHasError(false);
    }
    onError === null || onError === void 0 || onError({
      e: e
    });
  };
  var imgRef = React.useRef();
  React.useEffect(function () {
    if (hasError && previewUrl) {
      setHasError(false);
    }
    previewUrl && isImageValid(previewUrl).then(function (isValid) {
      setTimeout(function () {
        if (!isValid && !isFirstError.current) {
          handleError(imgRef.current);
        }
      }, 0);
    });
  }, [previewUrl]);
  React.useEffect(function () {
    if (imgRef.current) {
      var _imgRef$current = imgRef.current,
        complete = _imgRef$current.complete,
        naturalWidth = _imgRef$current.naturalWidth,
        naturalHeight = _imgRef$current.naturalHeight;
      if (complete && naturalWidth !== 0 && naturalHeight !== 0) {
        handleLoad(imgRef.current);
      }
    }
  }, []);
  var hasMouseEvent = overlayTrigger === "hover";
  var _useState9 = React.useState(!hasMouseEvent),
    _useState10 = slicedToArray._slicedToArray(_useState9, 2),
    shouldShowOverlay = _useState10[0],
    setShouldShowOverlay = _useState10[1];
  var handleToggleOverlay = function handleToggleOverlay(overlay) {
    setShouldShowOverlay(overlay);
  };
  var renderOverlay = function renderOverlay() {
    if (!overlayContent) {
      return null;
    }
    return /* @__PURE__ */React__default["default"].createElement("div", {
      className: classNames__default["default"]("".concat(classPrefix, "-image__overlay-content"), !shouldShowOverlay && "".concat(classPrefix, "-image__overlay-content--hidden"))
    }, overlayContent);
  };
  var renderPlaceholder = function renderPlaceholder() {
    if (!placeholder) {
      return null;
    }
    return /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(classPrefix, "-image__placeholder")
    }, placeholder);
  };
  var renderGalleryShadow = function renderGalleryShadow() {
    if (!gallery) {
      return null;
    }
    return /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(classPrefix, "-image__gallery-shadow")
    });
  };
  var renderImage = function renderImage() {
    var url = typeof imageSrc === "string" ? imageSrc : previewUrl;
    return /* @__PURE__ */React__default["default"].createElement("img", {
      ref: imgRef,
      src: url,
      onError: handleError,
      onLoad: handleLoad,
      className: classNames__default["default"]("".concat(classPrefix, "-image"), "".concat(classPrefix, "-image--fit-").concat(fit), "".concat(classPrefix, "-image--position-").concat(position)),
      alt: alt,
      referrerPolicy: referrerpolicy
    });
  };
  var renderImageSrcset = function renderImageSrcset() {
    return /* @__PURE__ */React__default["default"].createElement("picture", null, Object.entries(props.srcset).map(function (_ref) {
      var _ref2 = slicedToArray._slicedToArray(_ref, 2),
        type = _ref2[0],
        url = _ref2[1];
      return /* @__PURE__ */React__default["default"].createElement("source", {
        key: url,
        type: type,
        srcSet: url
      });
    }), props.src && renderImage());
  };
  return /* @__PURE__ */React__default["default"].createElement("div", _objectSpread(_objectSpread({
    ref: imageRef,
    className: classNames__default["default"]("".concat(classPrefix, "-image__wrapper"), "".concat(classPrefix, "-image__wrapper--shape-").concat(shape), gallery && "".concat(classPrefix, "-image__wrapper--gallery"), hasMouseEvent && "".concat(classPrefix, "-image__wrapper--need-hover"), className),
    style: style
  }, hasMouseEvent ? {
    onMouseEnter: function onMouseEnter() {
      return handleToggleOverlay(true);
    },
    onMouseLeave: function onMouseLeave() {
      return handleToggleOverlay(false);
    }
  } : null), rest), renderPlaceholder(), renderGalleryShadow(), !(hasError || !shouldLoad) && /* @__PURE__ */React__default["default"].createElement(React.Fragment, null, srcset && Object.keys(srcset).length ? renderImageSrcset() : renderImage(), !(hasError || !shouldLoad) && !isLoaded && /* @__PURE__ */React__default["default"].createElement("div", {
    className: "".concat(classPrefix, "-image__loading")
  }, loading || /* @__PURE__ */React__default["default"].createElement(space_index.Space, {
    direction: "vertical",
    size: 8,
    align: "center"
  }, /* @__PURE__ */React__default["default"].createElement(ImageIcon, {
    size: 24
  }), typeof loading === "string" ? loading : t(local.loadingText)))), hasError && /* @__PURE__ */React__default["default"].createElement("div", {
    className: "".concat(classPrefix, "-image__error")
  }, error || /* @__PURE__ */React__default["default"].createElement(space_index.Space, {
    direction: "vertical",
    size: 8,
    align: "center"
  }, /* @__PURE__ */React__default["default"].createElement(ImageErrorIcon, {
    size: 24
  }), typeof error === "string" ? error : t(local.errorText))), renderOverlay());
};
var Image = /*#__PURE__*/React__default["default"].forwardRef(InternalImage);
Image.displayName = "Image";

exports["default"] = Image;
exports.isImageValid = isImageValid;
//# sourceMappingURL=Image.js.map
