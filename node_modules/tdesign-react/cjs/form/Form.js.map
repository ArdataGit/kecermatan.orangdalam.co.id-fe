{"version":3,"file":"Form.js","sources":["../../src/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport useConfig from '../hooks/useConfig';\nimport noop from '../_util/noop';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport type { TdFormProps } from './type';\nimport useInstance from './hooks/useInstance';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useWatch from './hooks/useWatch';\nimport { StyledProps } from '../common';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\nimport useDefaultProps from '../hooks/useDefaultProps';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (originalProps: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n    const props = useDefaultProps<FormProps>(originalProps, formDefaultProps);\n    const {\n      style,\n      className,\n      labelWidth,\n      statusIcon,\n      labelAlign,\n      layout,\n      colon,\n      initialData,\n      requiredMark = globalFormConfig.requiredMark,\n      scrollToFirstError,\n      showErrorMessage,\n      resetType,\n      rules,\n      errorMessage = globalFormConfig.errorMessage,\n      preventSubmitDefault,\n      disabled,\n      children,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef = useRef<HTMLFormElement>();\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const formInstance = useInstance(props, formRef, formMapRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n    form?.getInternalHooks?.(HOOK_MARK)?.setForm?.(formInstance);\n\n    // form 初始化后清空队列\n    React.useEffect(() => {\n      form?.getInternalHooks?.(HOOK_MARK)?.flashQueue?.();\n    }, [form]);\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        formItemRef?.current.resetField();\n      });\n      form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.([]);\n      onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFields = formInstance.getFieldsValue(true);\n      onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n      // 禁用 input 输入框回车自动提交 form\n      if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n      if (preventSubmitDefault && e.key === 'Enter') {\n        e.preventDefault?.();\n        e.stopPropagation?.();\n      }\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          form,\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          colon,\n          initialData,\n          requiredMark,\n          errorMessage,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          disabled,\n          formMapRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form\n          ref={formRef}\n          style={style}\n          className={formClass}\n          onSubmit={formInstance.submit}\n          onReset={onResetHandler}\n          onKeyDown={onKeyDownHandler}\n        >\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { useForm, useWatch, FormItem, FormList },\n);\n\nForm.displayName = 'Form';\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","originalProps","ref","_form$getInternalHook","_form$getInternalHook2","_useConfig","useConfig","classPrefix","globalFormConfig","form","props","useDefaultProps","formDefaultProps","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","_props$requiredMark","requiredMark","scrollToFirstError","showErrorMessage","resetType","rules","_props$errorMessage","errorMessage","preventSubmitDefault","disabled","children","onReset","_props$onValuesChange","onValuesChange","noop","formClass","classNames","concat","_defineProperty","_useForm","useForm","_useForm2","_slicedToArray","formRef","useRef","formMapRef","Map","formInstance","useInstance","useImperativeHandle","Object","assign","_objectSpread","getInternalHooks","call","HOOK_MARK","setForm","React","useEffect","_form$getInternalHook3","_form$getInternalHook4","flashQueue","onResetHandler","e","_form$getInternalHook5","_form$getInternalHook6","_toConsumableArray","current","values","forEach","formItemRef","resetField","notifyWatch","onFormItemValueChange","changedValue","allFields","getFieldsValue","onKeyDownHandler","target","tagName","toLowerCase","key","_e$preventDefault","_e$stopPropagation","preventDefault","stopPropagation","createElement","FormContext","Provider","value","onSubmit","submit","onKeyDown","useWatch","FormItem","FormList","displayName"],"mappings":"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"}