{"version":3,"file":"OptionList.js","sources":["../../src/auto-complete/OptionList.tsx"],"sourcesContent":["import React, { useMemo, useState, useRef, MouseEvent, useEffect, useImperativeHandle, forwardRef } from 'react';\nimport classNames from 'classnames';\nimport isFunction from 'lodash/isFunction';\nimport escapeRegExp from 'lodash/escapeRegExp';\nimport useConfig from '../hooks/useConfig';\nimport log from '../_common/js/log';\nimport { CommonClassNameType } from '../hooks/useCommonClassName';\nimport { AutoCompleteOptionObj, TdAutoCompleteProps } from './type';\nimport HighlightOption from './HighlightOption';\nimport { on, off } from '../_util/dom';\n\nexport interface OptionsListProps {\n  sizeClassNames: CommonClassNameType['sizeClassNames'];\n  value: string;\n  size: TdAutoCompleteProps['size'];\n  options: TdAutoCompleteProps['options'];\n  popupVisible: boolean;\n  highlightKeyword: boolean;\n  filterable: boolean;\n  filter: TdAutoCompleteProps['filter'];\n  onSelect?: (keyword: string, context: { e: MouseEvent<HTMLLIElement> | KeyboardEvent | any }) => void;\n}\n\nexport interface OptionsListRef {\n  addKeyboardListener: () => void;\n  removeKeyboardListener: () => void;\n}\n\nconst OptionsList = forwardRef<OptionsListRef, OptionsListProps>((props: OptionsListProps, ref) => {\n  const { value, popupVisible, onSelect } = props;\n  const { classPrefix } = useConfig();\n  const [active, setActive] = useState('');\n  const activeIndexRef = useRef(-1);\n\n  const classes = `${classPrefix}-select__list`;\n  const optionClasses = [\n    `${classPrefix}-select-option`,\n    {\n      [props.sizeClassNames[props.size]]: props.size,\n    },\n  ];\n\n  const tOptions = useMemo(() => {\n    let options = (props.options || []).map((item) => {\n      let option: AutoCompleteOptionObj = {};\n      if (typeof item === 'string') {\n        option = { text: item, label: item };\n      } else {\n        if (item.text && typeof item.text !== 'string') {\n          log.warn('AutoComplete', '`text` must be a string.');\n        }\n        if (!item.text) {\n          if (typeof item.label === 'string') {\n            option = { ...item, text: item.label };\n          } else {\n            log.warn('AutoComplete', 'one of `label` and `text` must be a existed string.');\n          }\n        } else {\n          option = item;\n        }\n      }\n      return option;\n    });\n    // 自定义过滤规则\n    if (props.filter) {\n      options = options.filter((option) => props.filter(value, option));\n    } else if (props.filterable) {\n      // 默认过滤规则\n      const regExp = new RegExp(escapeRegExp(value), 'i');\n      options = options.filter((item) => regExp.test(item.text));\n    }\n\n    return options;\n    // eslint-disable-next-line\n  }, [props.options, value, props.filterable]);\n\n  const onOptionClick = (e: MouseEvent<HTMLLIElement>) => {\n    let liNode = e.target as HTMLElement;\n    while (liNode && liNode.tagName !== 'LI') {\n      liNode = liNode.parentNode as HTMLElement;\n    }\n    const keyword = liNode.getAttribute('title');\n    setActive(keyword);\n    onSelect?.(keyword, { e });\n  };\n\n  // 键盘事件，上下选择\n  const onKeyInnerPress = (e: KeyboardEvent) => {\n    if (e.code === 'Enter' || e.key === 'Enter') {\n      const currentIndex = activeIndexRef.current;\n\n      if (currentIndex === -1) {\n        return\n      }\n\n      onSelect?.(tOptions[activeIndexRef.current].text, { e });\n    } else {\n      const index = activeIndexRef.current;\n      let newIndex;\n      if (e.code === 'ArrowUp' || e.key === 'ArrowUp') {\n        newIndex = index - 1 < 0 ? tOptions.length - 1 : index - 1;\n      } else if (e.code === 'ArrowDown' || e.key === 'ArrowDown') {\n        newIndex = index + 1 >= tOptions.length ? 0 : index + 1;\n      }\n      setActive(tOptions[newIndex]?.text);\n    }\n  };\n\n  const addKeyboardListener = () => {\n    on(document, 'keydown', onKeyInnerPress);\n  };\n\n  const removeKeyboardListener = () => {\n    off(document, 'keydown', onKeyInnerPress);\n  };\n\n  useImperativeHandle(ref, () => ({\n    addKeyboardListener,\n    removeKeyboardListener,\n  }));\n\n  useEffect(() => {\n    if (popupVisible) {\n      addKeyboardListener();\n    } else {\n      removeKeyboardListener();\n    }\n    return () => {\n      removeKeyboardListener();\n    };\n    // eslint-disable-next-line\n  }, [popupVisible]);\n\n  useEffect(() => {\n    if (!value) {\n      setActive('');\n    }\n  }, [value]);\n\n  useEffect(() => {\n    activeIndexRef.current = tOptions.findIndex((item) => item.text === active);\n  }, [active, tOptions]);\n\n  if (!tOptions.length) return null;\n  return (\n    <ul className={classes}>\n      {tOptions.map((item) => {\n        const cls = [...optionClasses];\n        if (item.text === active) {\n          cls.push(`${classPrefix}-select-option--hover`);\n        }\n        const content = (isFunction(item.label) ? item.label() : item.label) || item.text;\n        return (\n          <li key={item.text} className={classNames(cls)} title={item.text} onClick={onOptionClick}>\n            {typeof content === 'string' && props.highlightKeyword ? (\n              <HighlightOption content={content} keyword={value} />\n            ) : (\n              content\n            )}\n          </li>\n        );\n      })}\n    </ul>\n  );\n});\n\nOptionsList.displayName = 'OptionsList';\n\nexport default OptionsList;\n"],"names":["OptionsList","forwardRef","props","ref","value","popupVisible","onSelect","_useConfig","useConfig","classPrefix","_useState","useState","_useState2","_slicedToArray","active","setActive","activeIndexRef","useRef","classes","optionClasses","concat","_defineProperty","sizeClassNames","size","tOptions","useMemo","options","map","item","option","text","label","log","warn","_objectSpread","filter","filterable","regExp","RegExp","escapeRegExp","test","onOptionClick","e","liNode","target","tagName","parentNode","keyword","getAttribute","onKeyInnerPress","code","key","currentIndex","current","_tOptions$newIndex","index","newIndex","length","addKeyboardListener","on","document","removeKeyboardListener","off","useImperativeHandle","useEffect","findIndex","React","createElement","className","cls","push","content","isFunction","classNames","title","onClick","highlightKeyword","HighlightOption","displayName"],"mappings":"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"}