{"version":3,"file":"useTreeDataExpand.js","sources":["../../../src/table/hooks/useTreeDataExpand.ts"],"sourcesContent":["import { useEffect, useState } from 'react';\nimport usePrevious from '../../hooks/usePrevious';\nimport { TdEnhancedTableProps, TableRowData } from '../type';\nimport useControlled from '../../hooks/useControlled';\nimport TableTreeStore, { diffExpandedTreeNode, getUniqueRowValue } from '../../_common/js/table/tree-store';\nimport { TableTreeExpandType } from '../interface';\n\nexport function useTreeDataExpand(\n  props: TdEnhancedTableProps,\n  params: {\n    store: InstanceType<typeof TableTreeStore>;\n    dataSource: TdEnhancedTableProps['data'];\n    setDataSource: React.Dispatch<React.SetStateAction<TableRowData[]>>;\n    rowDataKeys: { rowKey: string; childrenKey: string };\n  },\n) {\n  const { store, dataSource, rowDataKeys, setDataSource } = params;\n  const { data, tree } = props;\n\n  const [isDefaultExpandAllExecute, setIsDefaultExpandAllExecute] = useState(false);\n  const [tExpandedTreeNode, setTExpandedTreeNode] = useControlled(\n    props,\n    'expandedTreeNodes',\n    props.onExpandedTreeNodesChange,\n    {\n      defaultExpandedTreeNodes: props.defaultSelectedRowKeys || [],\n    },\n  );\n\n  const oldExpandedTreeNode = usePrevious(tExpandedTreeNode);\n\n  const [changedExpandTreeNode, setChangedExpandTreeNode] = useState<{\n    type?: TableTreeExpandType;\n    row?: TableRowData;\n    rowIndex?: number;\n  }>({ type: 'props-change' });\n\n  /**\n   * 对外暴露的组件实例方法，展开所有节点\n   */\n  function expandAll(type: 'expand-all' | 'default-expand-all' = 'expand-all', list?: TableRowData[]) {\n    const newData = list || data;\n    setDataSource(store.expandAll(newData, rowDataKeys));\n    const expandedNode = dataSource.map((t) => getUniqueRowValue(t, rowDataKeys.rowKey));\n    setTExpandedTreeNode(expandedNode, {\n      row: undefined,\n      rowState: undefined,\n      rowIndex: undefined,\n      type: 'expand',\n      trigger: type,\n    });\n    setChangedExpandTreeNode({ type: 'expand-all' });\n  }\n\n  /**\n   * 对外暴露的组件实例方法，收起所有节点\n   */\n  function foldAll() {\n    setDataSource([...store.foldAll(dataSource, rowDataKeys)]);\n    setTExpandedTreeNode([], {\n      row: undefined,\n      rowState: undefined,\n      rowIndex: undefined,\n      type: 'fold',\n      trigger: 'fold-all',\n    });\n  }\n\n  function onExpandFoldIconClick(\n    p: { row: TableRowData; rowIndex: number },\n    trigger?: 'expand-fold-icon' | 'row-click',\n  ) {\n    const { row, rowIndex } = p;\n    setChangedExpandTreeNode({\n      type: 'user-reaction-change',\n      ...p,\n    });\n    const rowValue = getUniqueRowValue(row, rowDataKeys.rowKey);\n    const rowState = store.treeDataMap.get(rowValue);\n    let expandedNodes = [...tExpandedTreeNode];\n    if (rowState.expanded) {\n      const expandedChildrenKeys = store.getExpandedChildrenKeys([row], rowDataKeys);\n      for (let i = 0, len = expandedNodes.length; i < len; i++) {\n        const nodeValue = expandedNodes[i];\n        if (expandedChildrenKeys.includes(nodeValue)) {\n          expandedNodes[i] = undefined;\n        }\n      }\n      expandedNodes = expandedNodes.filter(Boolean);\n    } else {\n      expandedNodes.push(rowValue);\n    }\n    const params = {\n      row,\n      rowIndex,\n      rowState,\n      trigger,\n    };\n    setTExpandedTreeNode(expandedNodes, {\n      ...params,\n      type: rowState.expanded ? 'fold' : 'expand',\n    });\n    props.onTreeExpandChange?.(params);\n  }\n\n  function updateExpandState(\n    data: TableRowData[],\n    tExpandedTreeNode: (string | number)[],\n    oldExpandedTreeNode: (string | number)[] = [],\n  ) {\n    const { addedList, removedList } = diffExpandedTreeNode(tExpandedTreeNode, oldExpandedTreeNode);\n    store.expandTreeNode(addedList, data, rowDataKeys);\n    store.foldTreeNode(removedList, data, rowDataKeys);\n    return data;\n  }\n\n  useEffect(() => {\n    if (!store.treeDataMap.size) return;\n    if (changedExpandTreeNode.type === 'user-reaction-change') {\n      const { row, rowIndex } = changedExpandTreeNode || {};\n      const newData = store.toggleExpandData({ row, rowIndex }, dataSource, rowDataKeys);\n      setDataSource([...newData]);\n    } else if (changedExpandTreeNode.type === 'props-change') {\n      updateExpandState([...dataSource], tExpandedTreeNode, oldExpandedTreeNode);\n    }\n    if (changedExpandTreeNode.type !== 'props-change') {\n      setChangedExpandTreeNode({ type: 'props-change' });\n    }\n    // eslint-disable-next-line\n  }, [tExpandedTreeNode]);\n\n  const updateExpandOnDataChange = (data: TableRowData[]) => {\n    if (tree?.defaultExpandAll && !isDefaultExpandAllExecute) {\n      expandAll('default-expand-all', [...data]);\n      setIsDefaultExpandAllExecute(true);\n    } else if (tExpandedTreeNode?.length) {\n      const newData = updateExpandState([...data], tExpandedTreeNode, []);\n      setDataSource([...newData]);\n    }\n  };\n\n  return {\n    tExpandedTreeNode,\n    isDefaultExpandAllExecute,\n    expandAll,\n    foldAll,\n    onExpandFoldIconClick,\n    updateExpandOnDataChange,\n  };\n}\n\nexport default useTreeDataExpand;\n"],"names":["useTreeDataExpand","props","params","store","dataSource","rowDataKeys","setDataSource","data","tree","_useState","useState","_useState2","_slicedToArray","isDefaultExpandAllExecute","setIsDefaultExpandAllExecute","_useControlled","useControlled","onExpandedTreeNodesChange","defaultExpandedTreeNodes","defaultSelectedRowKeys","_useControlled2","tExpandedTreeNode","setTExpandedTreeNode","oldExpandedTreeNode","usePrevious","_useState3","type","_useState4","changedExpandTreeNode","setChangedExpandTreeNode","expandAll","arguments","length","undefined","list","newData","expandedNode","map","t","getUniqueRowValue","rowKey","row","rowState","rowIndex","trigger","foldAll","_toConsumableArray","onExpandFoldIconClick","p","_props$onTreeExpandCh","_objectSpread","rowValue","treeDataMap","get","expandedNodes","expanded","expandedChildrenKeys","getExpandedChildrenKeys","i","len","nodeValue","includes","filter","Boolean","push","onTreeExpandChange","call","updateExpandState","_diffExpandedTreeNode","diffExpandedTreeNode","addedList","removedList","expandTreeNode","foldTreeNode","useEffect","size","_ref","toggleExpandData","updateExpandOnDataChange","defaultExpandAll"],"mappings":"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"}