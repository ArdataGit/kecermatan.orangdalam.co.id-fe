{"version":3,"file":"Watermark.js","sources":["../../src/watermark/Watermark.tsx"],"sourcesContent":["/* eslint-disable no-nested-ternary */\nimport React, { useCallback, useState, useEffect, useRef } from 'react';\nimport classNames from 'classnames';\nimport { StyledProps } from '../common';\nimport generateBase64Url from '../_common/js/watermark/generateBase64Url';\nimport randomMovingStyle from '../_common/js/watermark/randomMovingStyle';\nimport injectStyle from '../_common/js/utils/injectStyle';\nimport useConfig from '../hooks/useConfig';\nimport useMutationObserver from '../_util/useMutationObserver';\nimport { TdWatermarkProps } from './type';\nimport { watermarkDefaultProps } from './defaultProps';\nimport { getStyleStr } from './utils';\nimport useDefaultProps from '../hooks/useDefaultProps';\n\nexport interface WatermarkProps extends TdWatermarkProps, StyledProps {}\n\nconst Watermark: React.FC<WatermarkProps> = (originalProps) => {\n  const props = useDefaultProps<WatermarkProps>(originalProps, watermarkDefaultProps);\n  const {\n    alpha,\n    x = 200,\n    y = 210,\n    width = 120,\n    height = 60,\n    rotate: tempRotate,\n    zIndex = 10,\n    lineSpace,\n    isRepeat,\n    removable,\n    movable,\n    moveInterval,\n    offset = [],\n    content,\n    children,\n    watermarkContent,\n    className,\n    style = {},\n  } = props;\n\n  const { classPrefix } = useConfig();\n\n  let gapX = x;\n  let gapY = y;\n  let rotate = tempRotate;\n  if (movable) {\n    gapX = 0;\n    gapY = 0;\n    rotate = 0;\n  }\n  const clsName = `${classPrefix}-watermark`;\n  const [base64Url, setBase64Url] = useState('');\n  const styleStr = useRef('');\n  const watermarkRef = useRef<HTMLDivElement>();\n  const watermarkImgRef = useRef<HTMLDivElement>();\n  const stopObservation = useRef(false);\n  const offsetLeft = offset[0] || gapX / 2;\n  const offsetTop = offset[1] || gapY / 2;\n\n  // 水印节点 - 背景base64\n  useEffect(() => {\n    generateBase64Url(\n      {\n        width,\n        height,\n        rotate,\n        lineSpace,\n        alpha,\n        gapX,\n        gapY,\n        watermarkContent,\n        offsetLeft,\n        offsetTop,\n      },\n      (url) => {\n        setBase64Url(url);\n      },\n    );\n  }, [width, height, rotate, zIndex, lineSpace, alpha, offsetLeft, offsetTop, gapX, gapY, watermarkContent]);\n\n  // 水印节点 - styleStr\n  useEffect(() => {\n    styleStr.current = getStyleStr({\n      zIndex,\n      position: 'absolute',\n      left: 0,\n      right: 0,\n      top: 0,\n      bottom: 0,\n      width: movable ? `${width}px` : '100%',\n      height: movable ? `${height}px` : '100%',\n      backgroundSize: `${gapX + width}px`,\n      pointerEvents: 'none',\n      backgroundRepeat: movable ? 'no-repeat' : isRepeat ? 'repeat' : 'no-repeat',\n      backgroundImage: `url('${base64Url}')`,\n      animation: movable ? `watermark infinite ${(moveInterval * 4) / 60}s` : 'none',\n      ...style,\n    });\n  }, [zIndex, gapX, width, movable, isRepeat, base64Url, moveInterval, style, height]);\n\n  // 水印节点 - 渲染\n  const renderWatermark = useCallback(() => {\n    // 停止监听\n    stopObservation.current = true;\n    // 删除之前\n    watermarkImgRef.current?.remove?.();\n    watermarkImgRef.current = undefined;\n    // 创建新的\n    watermarkImgRef.current = document.createElement('div');\n    watermarkImgRef.current.setAttribute('style', styleStr.current);\n    watermarkRef.current?.append(watermarkImgRef.current);\n    // 继续监听\n    setTimeout(() => {\n      stopObservation.current = false;\n    });\n  }, []);\n\n  // 水印节点 - 初始化渲染\n  useEffect(() => {\n    renderWatermark();\n  }, [renderWatermark, zIndex, gapX, width, movable, isRepeat, base64Url, moveInterval, style, className]);\n\n  // 水印节点 - 变化时重新渲染\n  useMutationObserver(watermarkRef.current, (mutations) => {\n    if (stopObservation.current) return;\n    if (removable) return;\n    mutations.forEach((mutation) => {\n      // 水印节点被删除\n      if (mutation.type === 'childList') {\n        const removeNodes = mutation.removedNodes;\n        removeNodes.forEach((node) => {\n          const element = node as HTMLElement;\n          if (element === watermarkImgRef.current) {\n            renderWatermark();\n          }\n        });\n      }\n      // 水印节点其他变化\n      if (mutation.target === watermarkImgRef.current) {\n        renderWatermark();\n      }\n    });\n  });\n\n  // 组件父节点 - 增加keyframes\n  const parent = useRef<HTMLElement>();\n  useEffect(() => {\n    parent.current = watermarkRef.current.parentElement;\n    const keyframesStyle = randomMovingStyle();\n    injectStyle(keyframesStyle);\n  }, []);\n\n  // 水印节点的父节点 - 防删除\n  useMutationObserver(typeof document !== 'undefined' ? document.body : null, (mutations) => {\n    if (removable) return;\n    mutations.forEach((mutation) => {\n      if (mutation.type === 'childList') {\n        const removeNodes = mutation.removedNodes;\n        removeNodes.forEach((node) => {\n          const element = node as HTMLElement;\n          if (element === watermarkRef.current) {\n            parent.current.appendChild(element);\n          }\n        });\n      }\n    });\n  });\n\n  return (\n    <div className={classNames([clsName, className])} ref={watermarkRef}>\n      {children || content}\n    </div>\n  );\n};\n\nexport default Watermark;\n"],"names":["Watermark","originalProps","props","useDefaultProps","watermarkDefaultProps","alpha","_props$x","x","_props$y","y","_props$width","width","_props$height","height","tempRotate","rotate","_props$zIndex","zIndex","lineSpace","isRepeat","removable","movable","moveInterval","_props$offset","offset","content","children","watermarkContent","className","_props$style","style","_useConfig","useConfig","classPrefix","gapX","gapY","clsName","_useState","useState","_useState2","_slicedToArray","base64Url","setBase64Url","styleStr","useRef","watermarkRef","watermarkImgRef","stopObservation","offsetLeft","offsetTop","useEffect","generateBase64Url","url","current","getStyleStr","_objectSpread","position","left","right","top","bottom","concat","backgroundSize","pointerEvents","backgroundRepeat","backgroundImage","animation","renderWatermark","useCallback","_watermarkImgRef$curr","_watermarkImgRef$curr2","_watermarkRef$current","remove","call","document","createElement","setAttribute","append","setTimeout","useMutationObserver","mutations","forEach","mutation","type","removeNodes","removedNodes","node","element","target","parent","parentElement","keyframesStyle","randomMovingStyle","injectStyle","body","appendChild","React","classNames","ref"],"mappings":"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"}